<!DOCTYPE html>
<html>
  <head>
    <title>Metabolomics</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
    <span style="white-space: pre;"> </span><script src="/_utils/script/json2.js"></script>  
	<span style="white-space: pre;"> </span><script src="/_utils/script/jquery.js?1.3.1"></script>  
	<span style="white-space: pre;"> </span><script src="/_utils/script/jquery.couch.js?0.9.0"></script>  
	<span style="white-space: pre;"> 
	</span><script type="text/javascript">

		$db = $.couch.db("couchdb/metabolomics");
	    
	    function refreshList() {
	        $("div#items").empty();
	        
	        $("div#items").append('<div id="add_new"><button type="button" id="add_new">Add a new metabolite</button><p></p></div>');  

	        $db.view("metabolomics/known_keggIDs", {
	            success: function(data) {
	            	$("div#items").append("<table>");
	            	for (i in data.rows) {  
      					doc_id = data.rows[i].id;  
      					name = data.rows[i].key;  
      					keggID = data.rows[i].value.KeggID;  
						html = '<div><tr>' +  
						'<td>' + name + '</td> ' +  
						'<td>' + keggID + '</td> ' +  
						'<td><button class="edit" id="' + doc_id + '">edit</button></td> '+  
						'<td><button class="delete" id="' + doc_id + '">delete</button></td>'+  
						'</tr></div>';  
                        $("div#items").append(html);
                    }
                    $("div#items").append("</table>");
                }});
	    }
	    
	    function addUpdateForm(target, existingDoc) {  
  			html = '<form name="update" id="update" action=""> <table>' +  
      		'<tr><td>Name:</td><td> <input type="text" size="80" name="Name" id="Name" value="' +
			(existingDoc ? existingDoc.Name : "") + '"/></td></tr>' +  
      		'<tr><td>KeggID:</td><td> <input type="text" name="KeggID" id="KeggID"/ value="' +  
		    (existingDoc ? existingDoc.KeggID : "") + '"></td></tr>' +  
		    '<tr><td>HMDB Accession Number:</td><td> <input type="text" name="hmdb_id" id="hmdb_id"/ value="' +  
		    (existingDoc ? existingDoc.HMDB_id : "") + '"></td></tr>' + 
		    '<tr><td>Notes:</td><td> <textarea rows="4" cols="60" name="Notes" id="Notes">' + 
		    (existingDoc ? existingDoc.Notes : "") + '</textarea></td></tr>' +
      		'<tr><td><input type="submit" name="submit" class="update" value="' +
			(existingDoc?"Update":"Add") + '"/></td><td>' +   
      		'<input type="submit" name="cancel" class="cancel" value="Cancel"/></td></tr>' +   
    		'</table>' +
    		'<p>Appears in Pathways:' + (existingDoc ? existingDoc.Pathways : 'unknown') +
    		'</p></form>';  
  			target.append(html);  
  			target.children("form#update").data("existingDoc", existingDoc);  
		}  
	    
	    $(document).ready(function() {
	        
	        refreshList();
	        
	        $("button#add_new").click(function(event) {     
				$("form#update").remove();  
				$("button#add").hide();  
				addUpdateForm($("div#add_new"));  
			});
	        
	        $("div#items").click(function(event) {  
			var $tgt = $(event.target);  
				if ($tgt.is('button') || $tgt.is('a')) {  
				 	id = $tgt.attr("id");	
				 	if ($tgt.hasClass("edit")) { 
				 		$("button#add").show();  
      					$("form#update").remove();  
     	 				$db.openDoc(id, { success: function(doc) {  
        				addUpdateForm($tgt.parent(), doc);  
      					}});  
				 	}	
				 	if ($tgt.hasClass("delete")) {	 
				  		html = '<span class="deleteconfirm">Sure? <a href="#" class="dodelete">Yes</a> <a href="#" class="canceldelete">No</a></span>';  
				  		$tgt.parent().append(html);  
				 	}	
				 	if ($tgt.hasClass("dodelete")) {  
				  		$db.openDoc(id, { success: function(doc) {  
				   		$db.removeDoc(doc, { success: function() {  
						$tgt.parents("div.items").remove();	
				   		}})	
				  	}});		  
				 }	
				 	if ($tgt.hasClass("canceldelete")) {  
				  	$tgt.parents("span.deleteconfirm").remove();	
				 	}	
					}  
			   });	
	    	
	    	$("input.cancel").live('click', function(event) {  
    			$("button#add").show();  
   				$("form#update").remove();  
    			return false;  
  		 	});   
  		 	
  		 	$("input.update").live('click', function(event) {  
				var $tgt = $(event.target);  
				var $form = $tgt.parents("form#update");  
				var $doc = $form.data('existingDoc') || {};   
				$doc.Name = $form.find("input#Name").val();  
				$doc.KeggID = $.trim($form.find("input#KeggID").val());  
				$doc.HMDB_id = $.trim($form.find("input#hmdb_id").val());
				$doc.Notes = $.trim($form.find("textarea#Notes").val());
				$db.saveDoc(  
				 	$doc,  
				 	{success: function() {  
				  	$("button#add").show();  
				  	$("form#update").remove();  
				  	refreshList();  
					}});  
				return false;  
			   });  

	    });
	    
	</script>
	<span style="white-space: pre;"> </span>  
  </head>
  <body>
    <div id="account"></div>

    <h1>Database index for metabolites</h1>

    <div id="profile">
    <p>Generated for Vaisak!</p>
    <p>Visit the database admin <a href="http://abe-bhaleraolab.age.uiuc.edu/couchdb/_utils/database.html?metabolomics/_design/metabolomics/_view/metabolite-index">here</a><br />
    <a href="pathways.html">Explore pathways</a></p>
    </div>
    
    <div id="items">
    	items here...
    </div>

    <div id="sidebar">
      <h2>Instructions</h2>
      <p>Browse the database and add new information</p>
      <p>Click on the Edit / Delete buttons to edit and delete existing documents</p>
      <p>Add new documents by clicking 'Add a new metabolite' button above </p>
      <p>Let me know if you have trouble</p>
      </div>
  </body>
  <script src="vendor/couchapp/loader.js"></script>
</html>
